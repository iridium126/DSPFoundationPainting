#pragma once
#include "DataContainer.h"
#include <QHash>
#include <qmath.h>

namespace std {
	template<>
	struct hash<QPointF> {
		constexpr inline size_t operator()(const QPointF& key, size_t seed = 0) const noexcept {
			int x = static_cast<int>(key.x() * 100000000);
			int y = static_cast<int>(key.y() * 100000000);
			return qHashMulti(seed, x, y);
		}
	};
}

class TileRawData {
	friend DataGenerator;
public:
	TileRawData(int index[], int ipos, int jpos) :texture_pos(ipos, jpos)
	{
		memcpy(point_index, index, 4 * sizeof(int));
	}
private:
	int point_index[4];
	QPoint texture_pos; // 瓦片在纹理中的像素坐标
};

class DataGenerator
{
public:
	DataGenerator(DataContainer& container);
	~DataGenerator();

private:
	DataContainer& container;
	int point_count = 0;
	QHash<QPointF, int> index_map;
	std::vector<QPointF> points;
	std::vector<TileRawData> raw_data;

	void GenerateData();
	// 参数表示的区域有且仅有部分地基在图片范围内，四个bool类型参数表示四个定点调用point_is_in_painting的返回值
	void GenerateData(qreal min_polar_angle, qreal max_polar_angle, qreal min_azimuth_angle, qreal max_azimuth_angle, bool min_p_min_a_in_painting, bool min_p_max_a_in_painting, bool max_p_min_a_in_painting, bool max_p_max_a_in_painting);
	inline bool point_is_in_painting(qreal theta, qreal phi);
	inline bool float_equal(qreal lhs, qreal rhs);
	inline int float_floor(qreal value);
	inline qreal get_nearest_multiple(qreal value, qreal multiple_base); // multiple_base是倍数的基数
	void get_latitudinal_zone_range(int min_y, int max_y, int& min_l, int& max_l);
	qreal get_minimal_azimuth_angle(qreal min_polar_angle, qreal max_polar_angle);
	qreal get_minimal_azimuth_angle(qreal the_polar_angle);
	// min/max_m/n是min/max_x/y对应的地基内瓦片的局部坐标，min_m/n可能大于max_m/n
	void get_y_range(qreal min_polar_angle, qreal max_polar_angle, int& min_y, int& max_y, int& min_n, int& max_n);
	void get_x_range(qreal min_azimuth_angle, qreal max_azimuth_angle, int y, int& min_x, int& max_x, int& min_m, int& max_m, qreal& minimal_azimuth_angle, int& latitude_length);
	void init_tile_zone(int min_y, int max_y, int min_n, int max_n, qreal min_azimuth_angle, qreal max_azimuth_angle);
	void init_latitudinal_zone(int min_y, int max_y, int min_n, int max_n, qreal min_azimuth_angle, qreal max_azimuth_angle);
	int get_point_index(const QPointF& point);

	void ProcessData();
	QPointF spherical_to_screen_uv(const QPointF& point);

	static constexpr int edge_segments = 8; // 每块地基划分为8*8=64块瓦片
	static constexpr int latitudinal_zone_y[13] = { 0,80,130,155,180,195,210,220,230,235,240,245,250 }; // 纬度带最低纬度的y值

	static constexpr int precomputed_gcd_of_latitudinal_zone[78] = { 1000,200,200,100,100,100,100,20,20,20,20,20,
																	 800,200,100,100,100,100,20,20,20,20,20,
																	 600,100,100,100,100,20,20,20,20,20,
																	 500,100,100,100,20,20,20,20,20,
																	 400,100,100,20,20,20,20,20,
																	 300,100,20,20,20,20,20,
																	 200,40,20,20,20,20,
																	 160,20,20,20,20,
																	 100,20,20,20,
																	 80,40,20,
																	 40,20,
																	 20 };
	static constexpr const int* gcd_of_latitudinal_zone[12] = { precomputed_gcd_of_latitudinal_zone, precomputed_gcd_of_latitudinal_zone + 11,
		precomputed_gcd_of_latitudinal_zone + 21, precomputed_gcd_of_latitudinal_zone + 30, precomputed_gcd_of_latitudinal_zone + 38,
		precomputed_gcd_of_latitudinal_zone + 45, precomputed_gcd_of_latitudinal_zone + 51, precomputed_gcd_of_latitudinal_zone + 56,
		precomputed_gcd_of_latitudinal_zone + 60, precomputed_gcd_of_latitudinal_zone + 63, precomputed_gcd_of_latitudinal_zone + 65,
		precomputed_gcd_of_latitudinal_zone + 66 };
	static constexpr int reformOffsets[501] = { // 戴森球源码中的reformOffsets数组
		0,
		1000,
		2000,
		3000,
		4000,
		5000,
		6000,
		7000,
		8000,
		9000,
		10000,
		11000,
		12000,
		13000,
		14000,
		15000,
		16000,
		17000,
		18000,
		19000,
		20000,
		21000,
		22000,
		23000,
		24000,
		25000,
		26000,
		27000,
		28000,
		29000,
		30000,
		31000,
		32000,
		33000,
		34000,
		35000,
		36000,
		37000,
		38000,
		39000,
		40000,
		41000,
		42000,
		43000,
		44000,
		45000,
		46000,
		47000,
		48000,
		49000,
		50000,
		51000,
		52000,
		53000,
		54000,
		55000,
		56000,
		57000,
		58000,
		59000,
		60000,
		61000,
		62000,
		63000,
		64000,
		65000,
		66000,
		67000,
		68000,
		69000,
		70000,
		71000,
		72000,
		73000,
		74000,
		75000,
		76000,
		77000,
		78000,
		79000,
		80000,
		80800,
		81600,
		82400,
		83200,
		84000,
		84800,
		85600,
		86400,
		87200,
		88000,
		88800,
		89600,
		90400,
		91200,
		92000,
		92800,
		93600,
		94400,
		95200,
		96000,
		96800,
		97600,
		98400,
		99200,
		100000,
		100800,
		101600,
		102400,
		103200,
		104000,
		104800,
		105600,
		106400,
		107200,
		108000,
		108800,
		109600,
		110400,
		111200,
		112000,
		112800,
		113600,
		114400,
		115200,
		116000,
		116800,
		117600,
		118400,
		119200,
		120000,
		120600,
		121200,
		121800,
		122400,
		123000,
		123600,
		124200,
		124800,
		125400,
		126000,
		126600,
		127200,
		127800,
		128400,
		129000,
		129600,
		130200,
		130800,
		131400,
		132000,
		132600,
		133200,
		133800,
		134400,
		135000,
		135500,
		136000,
		136500,
		137000,
		137500,
		138000,
		138500,
		139000,
		139500,
		140000,
		140500,
		141000,
		141500,
		142000,
		142500,
		143000,
		143500,
		144000,
		144500,
		145000,
		145500,
		146000,
		146500,
		147000,
		147500,
		147900,
		148300,
		148700,
		149100,
		149500,
		149900,
		150300,
		150700,
		151100,
		151500,
		151900,
		152300,
		152700,
		153100,
		153500,
		153800,
		154100,
		154400,
		154700,
		155000,
		155300,
		155600,
		155900,
		156200,
		156500,
		156800,
		157100,
		157400,
		157700,
		158000,
		158200,
		158400,
		158600,
		158800,
		159000,
		159200,
		159400,
		159600,
		159800,
		160000,
		160160,
		160320,
		160480,
		160640,
		160800,
		160960,
		161120,
		161280,
		161440,
		161600,
		161700,
		161800,
		161900,
		162000,
		162100,
		162180,
		162260,
		162340,
		162420,
		162500,
		162540,
		162580,
		162620,
		162660,
		162700,
		162720,
		162740,
		162760,
		162780,
		162800,
		163800,
		164800,
		165800,
		166800,
		167800,
		168800,
		169800,
		170800,
		171800,
		172800,
		173800,
		174800,
		175800,
		176800,
		177800,
		178800,
		179800,
		180800,
		181800,
		182800,
		183800,
		184800,
		185800,
		186800,
		187800,
		188800,
		189800,
		190800,
		191800,
		192800,
		193800,
		194800,
		195800,
		196800,
		197800,
		198800,
		199800,
		200800,
		201800,
		202800,
		203800,
		204800,
		205800,
		206800,
		207800,
		208800,
		209800,
		210800,
		211800,
		212800,
		213800,
		214800,
		215800,
		216800,
		217800,
		218800,
		219800,
		220800,
		221800,
		222800,
		223800,
		224800,
		225800,
		226800,
		227800,
		228800,
		229800,
		230800,
		231800,
		232800,
		233800,
		234800,
		235800,
		236800,
		237800,
		238800,
		239800,
		240800,
		241800,
		242800,
		243600,
		244400,
		245200,
		246000,
		246800,
		247600,
		248400,
		249200,
		250000,
		250800,
		251600,
		252400,
		253200,
		254000,
		254800,
		255600,
		256400,
		257200,
		258000,
		258800,
		259600,
		260400,
		261200,
		262000,
		262800,
		263600,
		264400,
		265200,
		266000,
		266800,
		267600,
		268400,
		269200,
		270000,
		270800,
		271600,
		272400,
		273200,
		274000,
		274800,
		275600,
		276400,
		277200,
		278000,
		278800,
		279600,
		280400,
		281200,
		282000,
		282800,
		283400,
		284000,
		284600,
		285200,
		285800,
		286400,
		287000,
		287600,
		288200,
		288800,
		289400,
		290000,
		290600,
		291200,
		291800,
		292400,
		293000,
		293600,
		294200,
		294800,
		295400,
		296000,
		296600,
		297200,
		297800,
		298300,
		298800,
		299300,
		299800,
		300300,
		300800,
		301300,
		301800,
		302300,
		302800,
		303300,
		303800,
		304300,
		304800,
		305300,
		305800,
		306300,
		306800,
		307300,
		307800,
		308300,
		308800,
		309300,
		309800,
		310300,
		310700,
		311100,
		311500,
		311900,
		312300,
		312700,
		313100,
		313500,
		313900,
		314300,
		314700,
		315100,
		315500,
		315900,
		316300,
		316600,
		316900,
		317200,
		317500,
		317800,
		318100,
		318400,
		318700,
		319000,
		319300,
		319600,
		319900,
		320200,
		320500,
		320800,
		321000,
		321200,
		321400,
		321600,
		321800,
		322000,
		322200,
		322400,
		322600,
		322800,
		322960,
		323120,
		323280,
		323440,
		323600,
		323760,
		323920,
		324080,
		324240,
		324400,
		324500,
		324600,
		324700,
		324800,
		324900,
		324980,
		325060,
		325140,
		325220,
		325300,
		325340,
		325380,
		325420,
		325460,
		325500,
		325520,
		325540,
		325560,
		325580,
		325600
	};
};
